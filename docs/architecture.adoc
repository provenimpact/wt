= System Architecture
:version: 1.1.0
:last-updated: 2026-02-26
:toc:

== Feature Design Sources

[cols="1,1", options="header"]
|===
| Feature | Design Version

| worktree-management | 2.0.1
|===

== Overview

`wt` is a command-line tool written in Go that simplifies git worktree management. It wraps the `git worktree` command with an interactive TUI selector, a predictable directory convention, and shell integration for seamless directory switching.

The tool is a single static binary with no daemon, no persistent state, and no network access. It interacts with the local filesystem and the `git` CLI.

== System Context (C4 Level 1)

[source,mermaid]
----
C4Context
  title System Context Diagram

  Person(dev, "Developer", "Uses the terminal to manage git worktrees")
  System(wt, "wt CLI", "Git worktree management tool with TUI selector, fuzzy matching, branch sanitization, and shell integration")
  System_Ext(git, "git", "Version control system (local installation)")
  System_Ext(shell, "Shell", "User's shell (bash, zsh, or fish) with wt wrapper function and tab-completion")
  System_Ext(fs, "Filesystem", "Local filesystem where repos and worktrees reside")

  Rel(dev, shell, "Invokes wt commands")
  Rel(shell, wt, "Executes binary, evaluates cd output")
  Rel(wt, git, "Shells out for all git operations")
  Rel(wt, fs, "Creates/removes worktree directories")
----

The developer invokes `wt` through a shell wrapper function (installed via `wt init <shell>`). The wrapper captures `wt`'s stdout for cd sentinel detection and evaluates it to change the shell's working directory. All informational output goes to stderr. Tab-completion scripts (installed via `wt completion <shell>`) provide context-aware argument suggestions.

== Container View (C4 Level 2)

[source,mermaid]
----
C4Container
  title Container Diagram

  Person(dev, "Developer", "Terminal user")

  System_Boundary(wtsys, "wt CLI") {
    Container(binary, "wt binary", "Go", "Single static binary. Parses commands, orchestrates git operations, renders TUI.")
    Container(shellfn, "Shell wrapper function", "bash/zsh/fish", "Thin function that captures binary stdout and runs cd when __wt_cd: sentinel detected.")
    Container(shellcomp, "Shell completion script", "bash/zsh/fish", "Tab-completion scripts generated by Cobra. Provide context-aware argument suggestions.")
  }

  System_Ext(git, "git CLI", "Worktree, branch, and status operations")
  System_Ext(fs, "Filesystem", "Repo and worktree directories")

  Rel(dev, shellfn, "Types wt commands")
  Rel(dev, shellcomp, "Tab-completes wt arguments")
  Rel(shellfn, binary, "Executes with args, captures stdout")
  Rel(shellcomp, binary, "Invokes hidden __complete command")
  Rel(binary, git, "os/exec calls", "git worktree, git status, git branch, etc.")
  Rel(binary, fs, "mkdir, stat", "Worktree directory management")
  Rel(shellfn, dev, "cd to worktree / display stderr output")
----

== Component View (C4 Level 3)

The binary has meaningful internal structure worth documenting.

[source,mermaid]
----
C4Component
  title Component Diagram - wt binary

  Container_Boundary(binary, "wt binary") {
    Component(cmd, "Command Layer", "Go / cobra", "Parses CLI args and flags, routes to subcommands: create, remove, list, switch, status, init, completion. Provides ValidArgsFunction for tab-completion.")
    Component(tui, "TUI Module", "Go / bubbletea", "Interactive fuzzy-search selector for worktree entries and branch entries. Highlights matched characters using scored fuzzy results.")
    Component(names, "Names Module", "Go", "Sanitizes branch names into safe, flat directory names by replacing unsafe characters and collapsing separators.")
    Component(fuzzymod, "Fuzzy Module", "Go", "Scored fuzzy matching with contextual bonuses (first-char, separator boundary, camelCase, adjacency) and gap penalties.")
    Component(repo, "Repository Module", "Go", "Resolves main repo root and worktrees directory path. Works from main repo or any linked worktree.")
    Component(gitmod, "Git Module", "Go / os/exec", "Executes git commands: worktree list/add/remove, status, branch listing (local and remote), rev-list. Parses porcelain output.")
    Component(shellmod, "Shell Module", "Go", "Generates shell wrapper function code for bash, zsh, and fish.")
  }

  System_Ext(git, "git CLI", "Local git installation")

  Rel(cmd, tui, "Launches selector / branch selector")
  Rel(cmd, names, "Sanitizes branch names")
  Rel(cmd, repo, "Resolves paths")
  Rel(cmd, gitmod, "Worktree and branch operations")
  Rel(cmd, shellmod, "Generates init output")
  Rel(tui, fuzzymod, "Scores and ranks matches")
  Rel(gitmod, git, "os/exec")
  Rel(repo, git, "git rev-parse")
----

=== Component Responsibilities

**Command Layer** (`cmd/`) -- 9 cobra commands:

* `root` (no subcommand) -- interactive selector -> `__wt_cd:<path>` on stdout
* `create [branch]` -- creates worktree. When invoked without arguments, launches interactive branch selector. Supports `--base`, `--local`, `--remote` flags. Branch names are sanitized for directory paths. Outputs `__wt_cd:<path>` on stdout.
* `remove [name] [--force]` -- removes worktree, interactive selector if no arg. Cleans up empty parent directories after removal.
* `list` -- tabular worktree list to stderr
* `switch <name>` -- outputs `__wt_cd:<path>` on stdout. Matches by sanitized name or branch name.
* `status` -- tabular status with dirty/clean and ahead/behind to stderr
* `init <shell>` -- outputs shell function code to stdout
* `completion <shell>` -- outputs shell tab-completion script to stdout (bash, zsh, fish)
* hidden `__complete` -- Cobra's built-in completion protocol, invoked by shell completion scripts

Shared completion helpers (`cmd/completions.go`) provide `ValidArgsFunction` implementations for `create`, `switch`, and `remove` commands, returning existing worktree branch names for context-aware tab-completion.

**TUI Module** (`internal/tui/`) -- two interactive selectors:

* **Worktree selector** (`selector.go`) -- bubbletea model with fuzzy text input filter for worktree entries. Renders branch names and relative paths with highlighted match positions. Returns selected path on Enter, empty string on Esc/Ctrl-C. Uses scored fuzzy matching to rank results.
* **Branch selector** (`branch_selector.go`) -- bubbletea model for selecting a branch during interactive `create`. Displays local and remote branches with fuzzy filtering, ranked by score. Branches that already have worktrees are shown as disabled (dimmed with `[worktree]` marker) and cannot be selected. Accepts a header string parameter.

**Names Module** (`internal/names/`) -- `Sanitize()` function that converts branch names into safe, flat directory names. Characters not matching `[a-zA-Z0-9-.]` are replaced with `-`, consecutive dashes are collapsed, and leading/trailing dashes are trimmed. Used by the `create` and `switch` commands.

**Fuzzy Module** (`internal/fuzzy/`) -- `Score()` function implementing a greedy forward-scan scoring algorithm with case-insensitive matching. Returns a `Match` struct with score, match success, and character positions for highlighting. Scoring applies contextual bonuses: first-character (+16), separator boundary (+16), camelCase boundary (+16), adjacency (+8), and gap penalties: leading gap (-3/char), inter-match gap (-1/char). Used by both TUI selectors for ranking and highlighting.

**Repository Module** (`internal/repo/`) -- uses `git rev-parse --git-common-dir` to find the shared `.git` directory, derives main repo root as its parent, computes `<parent>/<name>-worktrees/` as the worktrees directory. Works transparently from main repo or any linked worktree.

**Git Module** (`internal/git/`) -- thin wrapper around `git` CLI via `os/exec`. Functions: `ListWorktrees`, `AddWorktree` (with `base` parameter for specifying start point), `RemoveWorktree`, `IsDirty`, `AheadBehind`, `BranchExists`, `ListLocalBranches`, `ListRemoteBranches` (deduplicates across remotes, strips remote prefix). All return structured Go types with wrapped errors.

**Shell Module** (`internal/shell/`) -- template strings for bash/zsh and fish shell functions. The wrapper captures `command wt` stdout, checks for `__wt_cd:` prefix, and runs `cd` if detected.

== Technology Stack

* **Language:** Go 1.26 -- <<adrs/0001-use-go.adoc#,ADR-0001>>
* **CLI framework:** cobra -- <<adrs/0002-use-cobra-for-cli.adoc#,ADR-0002>>
* **TUI:** bubbletea + bubbles + lipgloss -- <<adrs/0003-use-bubbletea-for-tui.adoc#,ADR-0003>>
* **Git interaction:** `os/exec` -> `git` CLI -- <<adrs/0004-shell-out-to-git.adoc#,ADR-0004>>
* **Fuzzy matching:** custom implementation (greedy forward-scan with scoring), no external dependency
* **Build:** single static binary, no CGO

== Data Flow

The system has no persistent state. All data flows through git and the filesystem:

[source,mermaid]
----
flowchart LR
    CMD["Command"] --> REPO["Resolve repo"]
    REPO -->|"git rev-parse"| GIT["git CLI"]
    GIT -->|".git common dir"| REPO
    REPO --> PATHS["Main repo path\nWorktrees dir path"]
    PATHS --> OP["Git operation"]
    OP -->|"git worktree list\nadd/remove/status\ngit branch"| GIT
    GIT -->|"Structured result"| OP
    OP --> OUT["Output"]
    OUT -->|"__wt_cd:<path>"| STDOUT["stdout\n(shell wrapper reads)"]
    OUT -->|"Tables, messages, errors"| STDERR["stderr\n(user sees directly)"]
----

=== Interactive Branch Selection Flow

When `wt create` is invoked without arguments, an interactive flow gathers branch information:

[source,mermaid]
----
flowchart TD
    CREATE["wt create (no args)"] --> FETCH["ListLocalBranches\nListRemoteBranches\nListWorktrees"]
    FETCH --> MERGE["Merge branches\nMark existing worktrees"]
    MERGE --> SELECTOR["Branch Selector TUI\n(fuzzy filter, scored ranking)"]
    SELECTOR -->|"Branch selected"| SANITIZE["Names.Sanitize(branch)"]
    SANITIZE --> ADD["git worktree add"]
    ADD --> CD["__wt_cd:<path>"]
    SELECTOR -->|"Cancelled"| EXIT["Exit 0"]
----

== Cross-Cutting Concerns

=== Output Convention

The stdout/stderr split is the core architectural pattern:

* **stdout** -- reserved exclusively for the `__wt_cd:<path>` sentinel and shell script output (`init`, `completion`). The shell wrapper function reads stdout and runs `cd` when detected.
* **stderr** -- all human-readable output: tables, status messages, errors, TUI rendering.

This ensures the shell wrapper never misinterprets informational output as a directory-change instruction.

=== Error Handling

All errors from git commands are wrapped with context using `fmt.Errorf("context: %w", err)`. Cobra's `SilenceErrors` and `SilenceUsage` are enabled; the root `Execute()` function prints errors to stderr with an `Error:` prefix.

=== Directory Convention

Worktrees are placed in `<parent>/<repo-name>-worktrees/<sanitized-branch>/` as a sibling to the main repository. Branch names are sanitized by the Names Module to produce safe, flat directory names. This convention is enforced by the Repository Module and is not configurable.

=== Repository Resolution

The `git rev-parse --git-common-dir` command is used to find the shared git directory. This works from both the main worktree (returns `.git` relative) and linked worktrees (returns the absolute path to the main repo's `.git`). The main repo root is the parent of this common dir.

=== Shell Completion

Tab-completion scripts are generated by Cobra's built-in completion system (`wt completion <shell>`). Individual commands register `ValidArgsFunction` callbacks that return context-appropriate suggestions (e.g., `switch` and `remove` suggest existing worktree branches). The completion protocol uses Cobra's hidden `__complete` command.
