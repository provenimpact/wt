= Specification: Worktree Management
:version: 1.2.0
:source-stories-version: 1.2.0
:last-updated: 2026-02-27
:feature: worktree-management
:prefix: WT
:toc:

== WT-001
When the user invokes `wt` with no arguments, the system shall display an interactive fuzzy-search selector listing all existing worktrees for the current repository, including the main worktree.

Type:: Event-driven
Source:: US-001: Criterion 1
Verification:: Run `wt` with no arguments in a repository that has worktrees. Confirm an interactive fuzzy-search selector appears listing all worktrees, including the main worktree.

== WT-002
The system shall display each worktree entry in the selector with its branch name and relative path.

Type:: Ubiquitous
Source:: US-001: Criterion 2
Verification:: Run `wt` with no arguments. Confirm each entry shows the branch name and relative path.

== WT-003
When the user selects a worktree from the interactive selector, the system shall output a directory-change instruction targeting the selected worktree directory.

Type:: Event-driven
Source:: US-001: Criterion 4
Verification:: Run `wt`, select a worktree. Confirm the output is a valid directory-change instruction pointing to the selected worktree.

== WT-004
If only the main worktree exists and no linked worktrees have been created, then the system shall display a message indicating no worktrees are available and suggest creating one.

Type:: Unwanted behavior
Source:: US-001: Criterion 5
Verification:: Run `wt` in a repository with only the main worktree and no linked worktrees. Confirm a helpful message is displayed suggesting the create command.

== WT-005
When the user cancels the interactive selector, the system shall exit without producing output.

Type:: Event-driven
Source:: US-001: Criterion 6
Verification:: Run `wt`, press Escape. Confirm the system exits silently with no output.

== WT-006
When the user invokes `wt create <branch>`, the system shall create a new git worktree in the repository's worktrees directory.

Type:: Event-driven
Source:: US-002: Criterion 1
Verification:: Run `wt create feature-x`. Confirm a new worktree exists in the worktrees directory.

== WT-007
The system shall place new worktrees in a directory named `<repository-name>-worktrees/<branch>` located as a sibling to the main repository directory.

Type:: Ubiquitous
Source:: US-002: Criterion 2, US-007: Criterion 1
Verification:: Run `wt create feature-x`. Confirm the worktree is located at `../<repo>-worktrees/feature-x` relative to the main repository.

== WT-008
When the user invokes `wt create <branch>` and no branch with that name exists locally or remotely, the system shall create a new branch with that name based on the current HEAD of the main worktree.

Type:: Event-driven
Source:: US-002: Criterion 3
Verification:: Run `wt create nonexistent-branch` where the branch does not exist. Confirm a new branch is created and the worktree checks it out.

== WT-009
When the user invokes `wt create <branch>` and a branch with that name already exists, the system shall check out that existing branch in the new worktree.

Type:: Event-driven
Source:: US-002: Criterion 4
Verification:: Create a branch `existing-branch`, then run `wt create existing-branch`. Confirm the worktree checks out the existing branch.

== WT-010
If a worktree for the specified branch already exists, then the system shall display an error message and not create a duplicate.

Type:: Unwanted behavior
Source:: US-002: Criterion 5
Verification:: Run `wt create feature-x` twice. Confirm the second invocation displays an error.

== WT-011
When a worktree is successfully created, the system shall output the path to the new worktree directory.

Type:: Event-driven
Source:: US-002: Criterion 6
Verification:: Run `wt create feature-x`. Confirm the output includes the path to the newly created worktree.

== WT-012
When the user invokes `wt remove <name>`, the system shall remove the specified git worktree and its directory.

Type:: Event-driven
Source:: US-003: Criterion 1
Verification:: Run `wt remove feature-x` for an existing worktree. Confirm the worktree directory is removed and `git worktree list` no longer includes it.

== WT-013
When the user invokes `wt remove` with no name argument, the system shall display an interactive selector to choose which worktree to remove.

Type:: Event-driven
Source:: US-003: Criterion 2
Verification:: Run `wt remove` with no arguments. Confirm an interactive selector appears.

== WT-014
If the specified worktree has uncommitted changes and the `--force` flag is not provided, then the system shall warn the user and refuse to remove the worktree.

Type:: Unwanted behavior
Source:: US-003: Criterion 3
Verification:: Create uncommitted changes in a worktree. Run `wt remove <name>` without `--force`. Confirm the system warns and does not remove it.

== WT-015
When the user invokes `wt remove <name> --force` on a worktree with uncommitted changes, the system shall remove the worktree.

Type:: Event-driven
Source:: US-003: Criterion 3
Verification:: Create uncommitted changes in a worktree. Run `wt remove <name> --force`. Confirm the worktree is removed.

== WT-016
If the specified worktree does not exist when invoking `wt remove`, then the system shall display an error message indicating the worktree was not found.

Type:: Unwanted behavior
Source:: US-003: Criterion 4
Verification:: Run `wt remove nonexistent`. Confirm an error message about the worktree not being found.

== WT-017
When a worktree is successfully removed, the system shall display a confirmation message.

Type:: Event-driven
Source:: US-003: Criterion 5
Verification:: Remove an existing worktree. Confirm a success message is displayed.

== WT-018
When the user invokes `wt list`, the system shall display all worktrees for the current repository, including the main worktree, with branch name, path, and main worktree indicator.

Type:: Event-driven
Source:: US-004: Criterion 1, US-004: Criterion 2
Verification:: Run `wt list` in a repository with multiple worktrees. Confirm all worktrees are listed with branch, path, and main indicator. Confirm the main worktree is included with a `*` marker.

== WT-019
If only the main worktree exists and no linked worktrees have been created, then the system shall display a message indicating no additional worktrees exist and suggest the `wt create` command.

Type:: Unwanted behavior
Source:: US-004: Criterion 3
Verification:: Run `wt list` with only the main worktree. Confirm a message indicates no additional worktrees and suggests creating one.

== WT-020
When the user invokes `wt switch <name>`, the system shall output a directory-change instruction targeting the specified worktree directory.

Type:: Event-driven
Source:: US-005: Criterion 1
Verification:: Run `wt switch feature-x` for an existing worktree. Confirm the output is a directory-change instruction to that worktree.

== WT-021
If the specified worktree does not exist when invoking `wt switch`, then the system shall display an error message and list all available worktrees, including the main worktree.

Type:: Unwanted behavior
Source:: US-005: Criterion 3
Verification:: Run `wt switch nonexistent`. Confirm an error is displayed along with a list of all available worktrees, including the main worktree.

== WT-022
When the user invokes `wt status`, the system shall display a summary of all worktrees including branch name, clean/dirty state, and ahead/behind remote counts.

Type:: Event-driven
Source:: US-006: Criterion 1, US-006: Criterion 2
Verification:: Run `wt status` with multiple worktrees in various states. Confirm each entry shows branch, clean/dirty, ahead/behind counts, and main worktree indicator.

== WT-023
If a worktree has uncommitted changes, the system shall indicate it as dirty in status output.

Type:: Unwanted behavior
Source:: US-006: Criterion 3
Verification:: Make changes in a worktree without committing. Run `wt status`. Confirm the worktree is marked as dirty.

== WT-024
When the user invokes any `wt` command from within an existing worktree, the system shall resolve the main repository and operate correctly.

Type:: Event-driven
Source:: US-007: Criterion 2
Verification:: Navigate into a worktree directory. Run `wt list`. Confirm it correctly lists all worktrees for the same repository.

== WT-025
When the worktrees directory does not exist, the system shall create it automatically when creating the first worktree.

Type:: Event-driven
Source:: US-007: Criterion 3
Verification:: Remove the worktrees directory. Run `wt create feature-x`. Confirm the worktrees directory is created automatically.

== WT-026
The system shall provide a shell function that wraps the `wt` binary, enabling directory change to the selected worktree.

Type:: Ubiquitous
Source:: US-008: Criterion 1
Verification:: Source the shell function. Run `wt` and select a worktree. Confirm the working directory changes to the selected worktree.

== WT-027
When the user invokes `wt init <shell>`, the system shall output the shell function code for the specified shell.

Type:: Event-driven
Source:: US-008: Criterion 3
Verification:: Run `wt init bash`. Confirm valid Bash function code is output. Repeat for `zsh` and `fish`.

== WT-028
The system shall support shell integration for Bash, Zsh, and Fish shells.

Type:: Ubiquitous
Source:: US-008: Criterion 2
Verification:: Run `wt init bash`, `wt init zsh`, and `wt init fish`. Confirm each produces valid shell-specific function code.

== WT-029
The system shall sanitize branch names when computing worktree directory paths by replacing characters not in `[a-zA-Z0-9-.]` with `-`.

Type:: Ubiquitous
Source:: US-009: Criterion 1
Verification:: Run `wt create fix/bug-123`. Confirm the worktree directory is named `fix-bug-123`, not `fix/bug-123`.

== WT-030
The system shall collapse consecutive `-` characters into a single `-` in sanitized worktree directory names.

Type:: Ubiquitous
Source:: US-009: Criterion 2
Verification:: Run `wt create fix//double`. Confirm the worktree directory is named `fix-double`, not `fix--double`.

== WT-031
The system shall trim leading and trailing `-` characters from sanitized worktree directory names.

Type:: Ubiquitous
Source:: US-009: Criterion 3
Verification:: Run `wt create /leading-slash`. Confirm the directory name does not start with `-`.

== WT-032
When the user invokes `wt create fix/bug-123`, the system shall create the worktree directory as `fix-bug-123` within the worktrees directory.

Type:: Event-driven
Source:: US-009: Criterion 4
Verification:: Run `wt create fix/bug-123`. Confirm a flat directory `fix-bug-123` exists in the worktrees directory and contains the checked-out branch.

== WT-033
The system shall preserve the original branch name for all git operations, using the sanitized name only for the worktree directory path.

Type:: Ubiquitous
Source:: US-009: Criterion 5
Verification:: Run `wt create fix/bug-123`. Run `git branch`. Confirm the branch is named `fix/bug-123` (not `fix-bug-123`). Confirm `wt list` shows `fix/bug-123` as the branch name.

== WT-034
When a worktree is removed, if the removal leaves empty parent directories within the worktrees directory, then the system shall remove those empty parent directories.

Type:: Event-driven
Source:: US-009: Criterion 6
Verification:: Create a worktree for a branch whose name previously caused nested directories (e.g., `fix/old`). Remove it with `wt remove`. Confirm no orphan `fix/` directory remains in the worktrees directory.

== WT-035
When the user invokes `wt create` with no arguments, the system shall display an interactive fuzzy-search selector listing all local and remote branches.

Type:: Event-driven
Source:: US-010: Criterion 1
Verification:: Run `wt create` with no arguments in a repository with local and remote branches. Confirm an interactive selector appears listing branches from both sources.

== WT-036
The interactive branch selector shall show branches that already have a worktree in a dimmed style with a marker, and those branches shall not be selectable.

Type:: Ubiquitous
Source:: US-010: Criterion 2
Verification:: Create a worktree for branch `main`. Run `wt create` with no arguments. Confirm `main` appears dimmed with a marker and cannot be selected.

== WT-037
When the user invokes `wt create` with the `--local` flag and no branch argument, the system shall list only local branches in the interactive selector.

Type:: Event-driven
Source:: US-010: Criterion 3
Verification:: Run `wt create --local`. Confirm only local branches are listed, no remote-only branches appear.

== WT-038
When the user invokes `wt create` with the `--remote` flag and no branch argument, the system shall list only remote branches in the interactive selector.

Type:: Event-driven
Source:: US-010: Criterion 4
Verification:: Run `wt create --remote`. Confirm only remote branches are listed, no local-only branches appear.

== WT-039
When the user invokes `wt create <branch>`, the system shall use the direct-branch creation flow without launching the interactive selector.

Type:: Event-driven
Source:: US-010: Criterion 5
Verification:: Run `wt create feature-x`. Confirm the worktree is created immediately without displaying an interactive selector.

== WT-040
When the user invokes `wt create <branch> --base <ref>`, the system shall create a new branch starting from the specified base reference and create a worktree for it.

Type:: Event-driven
Source:: US-010: Criterion 6
Verification:: Run `wt create new-feature --base main`. Confirm the branch `new-feature` is created from `main`'s HEAD and a worktree is created for it.

== WT-041
When the user selects a branch that does not already exist through the interactive create selector, the system shall display a second interactive selector for choosing the base branch.

Type:: Event-driven
Source:: US-010: Criterion 7
Verification:: Run `wt create`, type a new branch name that matches no existing branch, select it. Confirm a second selector appears listing available branches as base options.

== WT-042
If the user cancels either the branch selector or the base branch selector during interactive creation, then the system shall exit without creating a worktree.

Type:: Unwanted behavior
Source:: US-010: Criterion 8
Verification:: Run `wt create`, press Escape in the branch selector. Confirm no worktree is created. Repeat by cancelling in the base selector.

== WT-043
When the user presses Tab after `wt create`, the system shall suggest local and remote branch names, excluding branches that already have a worktree.

Type:: Event-driven
Source:: US-011: Criterion 1
Verification:: Source the completion script. Type `wt create ` and press Tab. Confirm branch names are suggested, and branches with existing worktrees are excluded.

== WT-044
When the user presses Tab after `wt switch`, the system shall suggest all existing worktree branch names, including the main worktree branch.

Type:: Event-driven
Source:: US-011: Criterion 2
Verification:: Source the completion script. Type `wt switch ` and press Tab. Confirm all existing worktree branch names are suggested, including the main worktree branch.

== WT-045
When the user presses Tab after `wt remove`, the system shall suggest existing linked worktree branch names.

Type:: Event-driven
Source:: US-011: Criterion 3
Verification:: Source the completion script. Type `wt remove ` and press Tab. Confirm linked worktree branch names are suggested (main worktree excluded).

== WT-046
The system shall provide a `wt completion <shell>` command that outputs shell-specific completion scripts for Bash, Zsh, and Fish.

Type:: Ubiquitous
Source:: US-011: Criterion 4
Verification:: Run `wt completion bash`, `wt completion zsh`, and `wt completion fish`. Confirm each produces a valid completion script for the respective shell.

== WT-047
If the user invokes `wt completion` with an unsupported shell name, then the system shall display an error listing the supported shells.

Type:: Unwanted behavior
Source:: US-011: Criterion 5
Verification:: Run `wt completion powershell`. Confirm an error is displayed that lists bash, zsh, and fish as supported options.

== WT-048
The system shall score fuzzy matches using a ranking algorithm that rewards first-character matches, separator-boundary matches, camelCase-boundary matches, and adjacent character matches, and penalizes large gaps between matched characters.

Type:: Ubiquitous
Source:: US-012: Criterion 1, US-012: Criterion 2
Verification:: In the interactive selector, type a pattern that matches multiple entries. Confirm the entry with the closest character-boundary alignment appears first (e.g., typing `sm` ranks `switch-main` above `some-random`).

== WT-049
The system shall sort filtered results in the interactive selector by descending match score so that the best matches appear at the top.

Type:: Ubiquitous
Source:: US-012: Criterion 3
Verification:: In the interactive selector, type a partial pattern. Confirm results are ordered with the highest-quality match at the top.

== WT-050
The system shall highlight the matched characters in each result entry in the interactive selector.

Type:: Ubiquitous
Source:: US-012: Criterion 4
Verification:: In the interactive selector, type a filter pattern. Confirm the characters that match the pattern are visually highlighted in each displayed entry.

== WT-051
When no filter text is entered in the interactive selector, the system shall display all entries in their original order without scoring.

Type:: Event-driven
Source:: US-012: Criterion 5
Verification:: Open the interactive selector. Without typing any filter text, confirm all entries are displayed in their default order.

== WT-052
While the main worktree entry is displayed in the interactive selector, the system shall render it with a visually distinct style to differentiate it from linked worktrees.

Type:: State-driven
Source:: US-001: Criterion 3, US-013: Criterion 2
Verification:: Run `wt` with no arguments in a repository with linked worktrees. Confirm the main worktree entry is rendered with a different visual style than linked worktree entries.

== WT-053
When the user selects the main worktree from the interactive selector, the system shall output a directory-change instruction targeting the main worktree directory.

Type:: Event-driven
Source:: US-013: Criterion 4
Verification:: Run `wt`, select the main worktree entry. Confirm the output is a valid directory-change instruction pointing to the main repository directory.

== WT-054
The system shall support switching to the main worktree by its branch name via `wt switch`.

Type:: Ubiquitous
Source:: US-005: Criterion 2
Verification:: Run `wt switch main` (where `main` is the main worktree branch). Confirm the output is a directory-change instruction targeting the main repository directory.

== WT-055
When the user invokes `wt remove` interactively or via tab completion, the system shall exclude the main worktree from the available choices.

Type:: Event-driven
Source:: US-013: Criterion 5
Verification:: Run `wt remove` with no arguments. Confirm the interactive selector does not include the main worktree. Source the completion script, type `wt remove ` and press Tab. Confirm the main worktree branch is not suggested.

== Traceability

[cols="1,2,2", options="header"]
|===
| Requirement ID | Requirement Summary | Source

| WT-001
| Interactive fuzzy selector on no-arg invocation (including main worktree)
| US-001: Criterion 1

| WT-002
| Selector entry shows branch and path
| US-001: Criterion 2

| WT-003
| Selection outputs directory-change instruction
| US-001: Criterion 4

| WT-004
| No linked worktrees message with suggestion
| US-001: Criterion 5

| WT-005
| Cancel exits silently
| US-001: Criterion 6

| WT-006
| Create worktree command
| US-002: Criterion 1

| WT-007
| Worktree placement convention
| US-002: Criterion 2, US-007: Criterion 1

| WT-008
| Create new branch if not exists
| US-002: Criterion 3

| WT-009
| Checkout existing branch
| US-002: Criterion 4

| WT-010
| Prevent duplicate worktree
| US-002: Criterion 5

| WT-011
| Output new worktree path
| US-002: Criterion 6

| WT-012
| Remove worktree and directory
| US-003: Criterion 1

| WT-013
| Interactive remove selector
| US-003: Criterion 2

| WT-014
| Refuse remove with uncommitted changes
| US-003: Criterion 3

| WT-015
| Force remove with uncommitted changes
| US-003: Criterion 3

| WT-016
| Error on nonexistent worktree remove
| US-003: Criterion 4

| WT-017
| Remove confirmation message
| US-003: Criterion 5

| WT-018
| List all worktrees including main with details
| US-004: Criterion 1, US-004: Criterion 2

| WT-019
| No additional worktrees message with suggestion
| US-004: Criterion 3

| WT-020
| Switch outputs directory-change instruction
| US-005: Criterion 1

| WT-021
| Switch error lists all worktrees including main
| US-005: Criterion 3

| WT-022
| Status summary with branch/dirty/remote
| US-006: Criterion 1, US-006: Criterion 2

| WT-023
| Dirty worktree indicator
| US-006: Criterion 3

| WT-024
| Commands work from within worktrees
| US-007: Criterion 2

| WT-025
| Auto-create worktrees directory
| US-007: Criterion 3

| WT-026
| Shell function for directory change
| US-008: Criterion 1

| WT-027
| Shell init command outputs function code
| US-008: Criterion 3

| WT-028
| Support Bash, Zsh, and Fish
| US-008: Criterion 2

| WT-029
| Sanitize branch names for directory paths
| US-009: Criterion 1

| WT-030
| Collapse consecutive hyphens in sanitized names
| US-009: Criterion 2

| WT-031
| Trim leading/trailing hyphens from sanitized names
| US-009: Criterion 3

| WT-032
| Create flat directory for branches with slashes
| US-009: Criterion 4

| WT-033
| Preserve original branch name for git operations
| US-009: Criterion 5

| WT-034
| Remove empty parent directories on worktree removal
| US-009: Criterion 6

| WT-035
| Interactive branch selector on no-arg create
| US-010: Criterion 1

| WT-036
| Dim and disable branches with existing worktrees
| US-010: Criterion 2

| WT-037
| Filter to local branches with --local flag
| US-010: Criterion 3

| WT-038
| Filter to remote branches with --remote flag
| US-010: Criterion 4

| WT-039
| Direct creation bypasses interactive selector
| US-010: Criterion 5

| WT-040
| Create branch from specified base reference
| US-010: Criterion 6

| WT-041
| Base branch selector for new branches in interactive mode
| US-010: Criterion 7

| WT-042
| Cancel in either selector exits without creating
| US-010: Criterion 8

| WT-043
| Tab completion for create suggests branches
| US-011: Criterion 1

| WT-044
| Tab completion for switch suggests all worktrees including main
| US-011: Criterion 2

| WT-045
| Tab completion for remove suggests linked worktrees
| US-011: Criterion 3

| WT-046
| Completion command outputs shell scripts
| US-011: Criterion 4

| WT-047
| Error on unsupported shell for completion
| US-011: Criterion 5

| WT-048
| Scored fuzzy matching with boundary bonuses
| US-012: Criterion 1, US-012: Criterion 2

| WT-049
| Sort results by descending match score
| US-012: Criterion 3

| WT-050
| Highlight matched characters in selector
| US-012: Criterion 4

| WT-051
| No scoring when filter is empty
| US-012: Criterion 5

| WT-052
| Main worktree visually distinct in selector
| US-001: Criterion 3, US-013: Criterion 2

| WT-053
| Selecting main worktree outputs directory-change instruction
| US-013: Criterion 4

| WT-054
| Switch to main worktree by branch name
| US-005: Criterion 2

| WT-055
| Exclude main worktree from remove choices
| US-013: Criterion 5
|===
