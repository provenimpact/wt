= User Stories: Worktree Management
:version: 1.1.0
:last-updated: 2026-02-26
:feature: worktree-management
:toc:

== US-001: Interactive Worktree Selection
As a developer,
I want to run `wt` with no arguments and get an interactive fuzzy-search selector of my existing worktrees,
so that I can quickly switch to the worktree I need without remembering its exact name.

Acceptance Criteria:

* [ ] When the user invokes `wt` with no arguments, the system shall display an interactive fuzzy-search selector listing all existing worktrees for the current repository.
* [ ] The system shall display each worktree entry with its branch name and relative path.
* [ ] When the user selects a worktree from the selector, the system shall output a `cd` command targeting the selected worktree directory.
* [ ] If no worktrees exist for the current repository, then the system shall display a message indicating no worktrees are available and suggest the `wt create` command.
* [ ] If the user cancels the selector (e.g., pressing Escape), then the system shall exit without output.

== US-002: Create Worktree
As a developer,
I want to create a new git worktree from a branch name,
so that I can work on multiple branches simultaneously without stashing or switching.

Acceptance Criteria:

* [ ] When the user invokes `wt create <branch>`, the system shall create a new git worktree in the repository's worktrees directory.
* [ ] The system shall place the new worktree in a sibling directory named `<repo>-worktrees/<branch>` relative to the main repository.
* [ ] When the user invokes `wt create <branch>` and the branch does not exist locally or remotely, the system shall create a new branch with that name based on the current HEAD of the main worktree.
* [ ] When the user invokes `wt create <branch>` and the branch exists, the system shall check out that existing branch in the new worktree.
* [ ] If a worktree for the specified branch already exists, then the system shall display an error message and not create a duplicate.
* [ ] When a worktree is successfully created, the system shall output the path to the new worktree directory.

== US-003: Remove Worktree
As a developer,
I want to remove a git worktree I no longer need,
so that I can keep my workspace clean and avoid confusion.

Acceptance Criteria:

* [ ] When the user invokes `wt remove <name>`, the system shall remove the specified git worktree and its directory.
* [ ] When the user invokes `wt remove` with no name argument, the system shall display an interactive selector to choose which worktree to remove.
* [ ] If the specified worktree has uncommitted changes, then the system shall warn the user and require a `--force` flag to proceed.
* [ ] If the specified worktree does not exist, then the system shall display an error message indicating the worktree was not found.
* [ ] When a worktree is successfully removed, the system shall display a confirmation message.

== US-004: List Worktrees
As a developer,
I want to see all worktrees for the current repository,
so that I can understand what branches I have checked out and where.

Acceptance Criteria:

* [ ] When the user invokes `wt list`, the system shall display all worktrees for the current repository.
* [ ] The system shall display each worktree with its branch name, path, and whether it is the main worktree.
* [ ] If no worktrees exist beyond the main worktree, then the system shall display a message indicating no additional worktrees exist.

== US-005: Switch to Worktree
As a developer,
I want to switch to a specific worktree by name without using the interactive selector,
so that I can navigate quickly when I already know the worktree name.

Acceptance Criteria:

* [ ] When the user invokes `wt switch <name>`, the system shall output a `cd` command targeting the specified worktree directory.
* [ ] If the specified worktree does not exist, then the system shall display an error message and list available worktrees.

== US-006: Worktree Status Overview
As a developer,
I want to see the status of all my worktrees at a glance,
so that I can identify which worktrees have uncommitted changes or are behind their remote.

Acceptance Criteria:

* [ ] When the user invokes `wt status`, the system shall display a summary of all worktrees including branch name, clean/dirty state, and ahead/behind remote counts.
* [ ] The system shall indicate which worktree is the main worktree.
* [ ] If a worktree has uncommitted changes, the system shall mark it as dirty.

== US-007: Worktree Directory Convention
As a developer,
I want worktrees to be stored in a predictable sibling directory,
so that my workspace stays organized and I can find worktrees from any repository.

Acceptance Criteria:

* [ ] The system shall store all worktrees in a directory named `<repository-name>-worktrees` located as a sibling to the main repository directory.
* [ ] When the user invokes any `wt` command from within an existing worktree, the system shall resolve the main repository and operate correctly.
* [ ] When the worktrees directory does not exist, the system shall create it automatically on the first `wt create` invocation.

== US-008: Shell Integration
As a developer,
I want `wt` to integrate with my shell so that selecting a worktree actually changes my working directory,
so that I do not have to manually copy and paste paths.

Acceptance Criteria:

* [ ] The system shall provide a shell function that wraps the `wt` binary, enabling `cd` to the selected worktree directory.
* [ ] The system shall support Bash, Zsh, and Fish shells.
* [ ] When the user invokes `wt init <shell>`, the system shall output the shell function code for the specified shell.
* [ ] The shell function shall execute the `wt` binary and evaluate its output to change directory when appropriate.

== US-009: Safe Worktree Directory Names
As a developer,
I want the tool to handle branch names with special characters like `/` correctly when creating worktree directories,
so that worktrees are always stored as flat directories and the tool does not break when I use branch naming conventions like `fix/bug-123`.

Acceptance Criteria:

* [ ] The system shall sanitize branch names when computing worktree directory paths by replacing characters not in `[a-zA-Z0-9-.]` with `-`.
* [ ] The system shall collapse consecutive `-` characters into a single `-` in sanitized directory names.
* [ ] The system shall trim leading and trailing `-` characters from sanitized directory names.
* [ ] When the user invokes `wt create fix/bug-123`, the system shall create the worktree directory as `fix-bug-123` within the worktrees directory.
* [ ] The system shall preserve the original branch name for all git operations, using the sanitized name only for the directory path.
* [ ] When a worktree is removed, if the removal leaves empty parent directories within the worktrees directory, then the system shall remove those empty parent directories.

== US-010: Interactive Branch Selection for Worktree Creation
As a developer,
I want to browse and fuzzy-search through available branches when creating a worktree without specifying the branch upfront,
so that I can discover and select branches interactively, including creating new branches with a chosen base.

Acceptance Criteria:

* [ ] When the user invokes `wt create` with no arguments, the system shall display an interactive fuzzy-search selector listing all local and remote branches.
* [ ] The system shall show branches that already have a worktree in a dimmed style with a marker, and those branches shall not be selectable.
* [ ] When the user invokes `wt create` with the `--local` flag, the system shall list only local branches.
* [ ] When the user invokes `wt create` with the `--remote` flag, the system shall list only remote branches.
* [ ] When the user invokes `wt create <branch>`, the system shall use the existing direct-branch creation flow without launching the interactive selector.
* [ ] When the user invokes `wt create <branch> --base <ref>`, the system shall create the new branch starting from the specified base reference.
* [ ] When the user creates a new branch (one that does not already exist) through the interactive selector, the system shall display a second interactive selector for choosing the base branch.
* [ ] If the user cancels either the branch selector or the base selector, then the system shall exit without creating a worktree.

== US-011: Shell Completion for Branch Arguments
As a developer,
I want tab-completion for branch and worktree names when typing commands,
so that I can use the CLI efficiently without having to type or remember full names.

Acceptance Criteria:

* [ ] When the user presses Tab after `wt create`, the system shall suggest local and remote branch names, excluding branches that already have a worktree.
* [ ] When the user presses Tab after `wt switch`, the system shall suggest existing worktree branch names.
* [ ] When the user presses Tab after `wt remove`, the system shall suggest existing linked worktree branch names.
* [ ] The system shall provide a `wt completion <shell>` command that outputs shell-specific completion scripts for Bash, Zsh, and Fish.
* [ ] If the user invokes `wt completion` with an unsupported shell, then the system shall display an error listing the supported shells.

== US-012: Ranked Fuzzy Matching
As a developer,
I want the fuzzy-search selector to rank results by match quality similar to fzf,
so that the most relevant matches appear first when I type a filter pattern.

Acceptance Criteria:

* [ ] The system shall score fuzzy matches using a ranking algorithm that rewards first-character matches, separator-boundary matches, camelCase-boundary matches, and adjacent character matches.
* [ ] The system shall penalize matches with large gaps between matched characters.
* [ ] The system shall sort filtered results by descending match score so that the best matches appear at the top.
* [ ] The system shall highlight the matched characters in each result entry in the interactive selector.
* [ ] When no filter text is entered, the system shall display all entries in their original order without scoring.
